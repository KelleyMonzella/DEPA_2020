---
title: "Survivor Analysis"
author: "Group 1"
date: "6/08/2020"
output:
  html_document:
    theme: cerulean
    highlight: tango
    code_folding: none
    toc: yes
    toc_depth: 3
    toc_float: true

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

#remove all objects from workspace
rm(list = ls())

# Load necessary packages
# general
library(tidyverse)
library(kableExtra)

# for cleaning and describing the data:
#install.packages('summarytools')
library(summarytools)

# for computation:
#install.packages('survival')
library(survival)

# for visualization and displaying statistics:
#install.packages('broom')
library(broom)
#install.packages('survminer')
library(survminer)
#install.packages('ggplot2')
library(ggplot2)
library(corrplot)


# Functions for data cleaning 
# for printing nice tables
mykable <- function(x, ...) {
  kable(x, ...) %>%
    kable_styling(bootstrap_options = c("responsive", "consensed", "hover", "striped"))
}

# for printing cross tabulations
tablist <- function(df, ...) {
  
  group_var <- quos(...)

  if (nrow(df)==0) {
    return("No observations")
  }
  
  df$tot <- nrow(df)
  
  df %>% 
    group_by(!!!group_var) %>%
    summarise(
      n   = n(),
      pct = max(100 * (n / tot))
    )

}

```

### Step 1: Read in and visualize the data
#### Check initial contents and summary statistics of data.
```{r readin, include=TRUE, results = 'asis', fig.width=4}
#load data into local environment
lung <- lung
# Describe data
dfSummary(lung, 
                plain.ascii  = FALSE, 
                style        = "grid", 
                graph.magnif = .75, 
                valid.col    = FALSE,
                varnumbers   = FALSE,
                tmp.img.dir  = "/tmp")


# Data documentation: https://www.rdocumentation.org/packages/survival/versions/3.1-12/topics/lung
```

#### Check first observations of data.
```{r readin2, include=TRUE, results = 'asis'}
# Check first observations for structure
mykable(head(lung[1:5,]))
```


### Step 2: Additional data cleaning
```{r cleaning, include = TRUE}


```

### Step 3: Additional constructs for analysis
```{r constructs, include=TRUE}

# calories weighted by age and sex?
# weight lost relative to age and sex?


lung <- lung %>%
         # create an age bracket variable for the purposes of visualization. Older and younger than 50
  mutate(age_brac = case_when(age  < 50  ~ 0,
                              age  >= 50 ~ 1,
                              TRUE       ~ NA_real_),
         # binary 0/1 indicators for censored (alive) vs. dead
         deceased = case_when(status==2  ~ 1,
                              status==1  ~ 0,
                              TRUE       ~ NA_real_))


```

### Step 4: Exploratory Data Analysis
```{r eda1, include=TRUE}
#look at correlations between variables
corrs <- cor(lung)
corrplot(corrs, method="circle")

#look at box plots
boxplot(lung$time~lung$sex,xlab="Sex categories",ylab="Survival Time",
        main="Survival Time versus Sex", outline=FALSE)

boxplot(lung$time~lung$age_brac,xlab="Age categories",ylab="Survival Time",
        main="Survival Time versus Age", outline=FALSE)

boxplot(lung$time~lung$ph.ecog,xlab="ECOG performance categories",ylab="Survival Time",
        main="Survival Time versus ECOG", outline=FALSE)
	
#For example, 

#(pl2 <- pl2 + guides(linetype = F) +
# scale_colour_discrete(name = 'Sex', breaks = c(1,2), labels=c('Male', 'Female')))

```

### Step 5: Check modeling assumptions
* Assumption 1: The Cox model assumes that the covariates do not vary with time. 
  + Example: Breast cancer chemotherapy patients were divided into three
groups based on whether the patient eventually received > 85%, 65â€“85% or < 65% of the dose
planned at the start of their treatment. Per the above, this approach leads to a severe bias since
early deaths do not finish all their cycles of chemotherapy and hence by definition get a lower
dose.   A proportional hazards model using total dose received shows a very strong effect for dose,
so much so that it could encourage a treating physician to defer necessary dose reductions in
response to treatment toxicity. This false result actively harmed patients.
+ If covariates do vary with time, they need to be addressed (https://cran.r-project.org/web/packages/survival/vignettes/timedep.pdf)
+ Time varying covariates vs. time varying coefficients. Both can be fit. try cox.zph to look at how the effect of variates changes over time
```{r assumptions, include=TRUE}

#For example, 
options(show.signif.stars = FALSE) # display user intelligence
vfit <- coxph(Surv(time, status) ~ sex + age_brac + ph.ecog + ph.karno + meal.cal + wt.loss, data=lung)
vfit

zp <- cox.zph(vfit, transform= function(time) log(time +20))
plot(zp)
#(pl2 <- pl2 + guides(linetype = F) +
# scale_colour_discrete(name = 'Sex', breaks = c(1,2), labels=c('Male', 'Female')))

```

### Step 5: Estimate models using functions and by hand

```{r modeling, results = 'asis'}
cox_initial  <- coxph(formula = Surv(time, status) ~ sex + age_brac + ph.ecog +ph.karno + pat.karno + meal.cal + wt.loss, data = lung) 

models <- list(cox_initial)

modelloop <- function(df){
  mykable(broom::tidy(
    df, 
    exp = TRUE
    )) 
}

map(models, modelloop)

```

### Step 6: Visualize and interpret results{.tabset}
#### Model 1
```{r results, fig.width=4}

# Fit the models
cox_fit     <- survfit(cox_initial)

# Visualize with survminer.
# Model 1: no explanatory variables
ggsurvplot(cox_fit, 
           data = lung, 
           risk.table = TRUE, 
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           title = "Model 1: Survivor Function")

ggsurvplot(cox_fit, 
           data = lung, 
           risk.table = TRUE, 
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           title = "Model 1: Hazard Function", fun = 'cumhaz')


```

#### Model 1: By Sex
```{r eda.3b, include=TRUE, fig.width=4}
# Model 1: including sex in the model

# Create the new data with averages for all other covariates except  
sex_df <- with(lung,
               data.frame(sex = c(1, 2), 
                          age_brac = rep(mean(age_brac, na.rm = TRUE), 2),
                          ph.ecog  = c(1, 1),
                          ph.karno = c(81.93833, 81.93833),
                          meal.cal = c(928.779, 928.779),
                          wt.loss  = c(9.831776, 9.831776),
                          pat.karno = c(79.95556, 79.95556)
                          )
               )

cox_fit_sex <- survfit(cox_initial, newdata = sex_df)


ggsurvplot(cox_fit_sex, 
           data = lung, 
           risk.table = FALSE, 
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           title = "Model 1: Survivor Function")

ggsurvplot(cox_fit_sex, 
           data = lung, 
           risk.table = FALSE, 
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           title = "Model 1: Hazard Function", 
           fun = 'cumhaz')
```

#### Model 1: By Age
```{r eda.3c, include=TRUE}
# Model 3: including age in the model
# ggsurvplot(cox_fit_age, data = lung, risk.table = TRUE)
```

#interactive viz: https://github.com/hinkelman/shiny-survival-covariate
#https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5580407/
#https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html#event_indicator
#http://www.sthda.com/english/wiki/cox-proportional-hazards-model

